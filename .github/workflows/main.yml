name: Autogenerate from Issue

on:
  issues:
    types: [opened, labeled]

permissions:
  contents: write
  pull-requests: write

jobs:
  generate:
    if: contains(github.event.issue.labels.*.name, 'autogenerate')
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Save issue body to file
        id: save_issue
        run: |
          echo "${{ github.event.issue.body }}" > issue_body.txt
          echo "issue saved"

      - name: Call OpenAI (generate files)
        id: call_openai
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        run: |
          # read prompt from file
          PROMPT=$(cat issue_body.txt)

          # build JSON payload safely using jq (runner includes jq)
          PAYLOAD=$(jq -n --arg p "$PROMPT" '{
            model: "gpt-5-thinking-mini",
            messages: [{role: "user", content: $p}],
            max_tokens: 2000,
            temperature: 0.0
          }')

          echo "Calling OpenAI..."
          response=$(curl -s -X POST https://api.openai.com/v1/chat/completions \
            -H "Authorization: Bearer $OPENAI_API_KEY" \
            -H "Content-Type: application/json" \
            -d "$PAYLOAD")

          echo "$response" > openai_raw.json

          # extract model content (chat completions)
          content=$(echo "$response" | jq -r '.choices[0].message.content // .choices[0].text // empty')
          if [ -z "$content" ]; then
            echo "ERROR: No usable content from OpenAI"
            echo "Raw response:"
            cat openai_raw.json
            exit 1
          fi
          echo "$content" > openai_content.txt
          echo "OpenAI responded and content saved."

      - name: Validate JSON and write files
        id: write_files
        run: |
          # Expecting openai_content.txt to contain a JSON array like:
          # [ {"path":"file","content_b64":"..."} , ... ]
          cat openai_content.txt > tmp.json

          # validate JSON
          if ! jq -e . tmp.json >/dev/null 2>&1; then
            echo "ERROR: OpenAI response is not valid JSON."
            echo "Response was:"
            sed -n '1,200p' tmp.json
            exit 1
          fi

          count=$(jq 'length' tmp.json)
          echo "Files to write: $count"

          for i in $(seq 0 $((count-1))); do
            path=$(jq -r ".[$i].path" tmp.json)
            b64=$(jq -r ".[$i].content_b64" tmp.json)
            if [ "$path" = "null" ] || [ -z "$b64" ]; then
              echo "Skipping invalid entry #$i"
              continue
            fi
            echo "Writing $path"
            mkdir -p "$(dirname "$path")"
            echo "$b64" | base64 --decode > "$path"
          done

      - name: Run optional tests (if project has tests)
        run: |
          if [ -f package.json ]; then
            if command -v npm >/dev/null 2>&1; then
              npm install --silent
              npm test || echo "Tests failed (continuing to PR creation)"
            else
              echo "Node not installed on runner; skipping npm test"
            fi
          else
            echo "No package.json found; skipping tests"
          fi

      - name: Create Pull Request with generated files
        uses: peter-evans/create-pull-request@v5
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "Autogenerated from Issue #${{ github.event.issue.number }}"
          branch: "autogen/issue-${{ github.event.issue.number }}"
          title: "Autogenerated: ${{ github.event.issue.title }}"
          body: |
            This PR was automatically generated from Issue #${{ github.event.issue.number }}.
            Issue body:
            ${{ github.event.issue.body }}
